---
import BaseLayout from "../../layouts/BaseLayout3p.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const tagCount = new Map<string, number>();

  allPosts.forEach((post) => {
    post.data.tags?.forEach((tag: string) => {
      tagCount.set(tag, (tagCount.get(tag) ?? 0) + 1);
    });
  });

  return [...tagCount.entries()].map(([tagName, count]) => ({
    params: { tag: tagName },
    props: { tagName, count },
  }));
}

export interface Props {
  tagName: string;
  count: number;
}

const { tagName, count } = Astro.props;
const { tag } = Astro.params;

const allPosts = await getCollection("blog");
const filteredPosts = allPosts
  .filter(post => post.data.tags?.includes(tag))
  .sort((a, b) => {
    return new Date(b.data.pubDate).getTime()
         - new Date(a.data.pubDate).getTime();
  });
---

<BaseLayout>
  <h5>The {tagName} has {count} blogs. The list is below:</h5>
  <ul class="tag-right-ul">
    {
      filteredPosts.map((post) => (
        <li>
          <a href={`/blog/${post.id}`}>            
           {post.data.title} â€” 
          <span class="post-date">
              {post.data.pubDate.toISOString().slice(0, 10)}
            </span></a>
        </li>
      ))
    }
  </ul>
</BaseLayout>
